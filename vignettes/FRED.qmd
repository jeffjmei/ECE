---
title: FRED Analysis
author: Jeffrey Mei
output: html_document
date: 2025-09-22
server: shiny
---

[This](https://arxiv.org/pdf/2207.12453) paper evaluates some data from the Federal Reserve Economic Database (FRED). Specifically, the data comes from [here](https://research.stlouisfed.org/econ/mccracken/fred-databases), but it can be easily cleaned from the `fbi` package on [github](https://github.com/cykbennie/fbi).


```{R}
#| context: setup
#| warning: false
#| echo: false

# Install Package
# devtools::install_github("cykbennie/fbi")
library(fbi)
library(tidyverse)
devtools::load_all("~/Documents/Research/Code/ECE")
```


```{R}
#| echo: false
#| message: false
#| warning: false
#| include: false
#directory <- "~/Documents/Research/Code/ECE/data/FRED/"
#df <- list.files(
#  path = directory,
#  pattern = "\\.csv$",   # only CSV files
#  full.names = TRUE
#) %>%
#  map_dfr(read_csv, .id = "file")  # adds a column showing source file

```

```{R}
# Load Data
#filepath <- paste0(directory, "2023-08.csv")
#data <- fredmd(filepath, date_start = NULL, date_end = NULL, transform = TRUE)
#N <- ncol(data)
#
## Remove Outliers
#data_clean <- rm_outliers.fredmd(data)
#
## Filter Time Period
#df <- data_clean %>% 
#  as_tibble() %>% 
#  filter(
#    date >= as.Date("2000-01-01"),
#    date <= as.Date("2022-12-01")
#  )
  
  #nrow(df)
  #ncol(df)
```


```{R}
#| context: server
df_reactive <- reactive({

  # Load Data
  directory <- "~/Documents/Research/Code/ECE/data/FRED/"
  filepath <- paste0(directory, "2023-08.csv")

  # Apply Transformation
  if(input$data_format == "raw"){
    # Raw Data
    data <- read_csv(filepath) %>%
      slice(-1) %>% 
      rename(date = sasdate) %>%
      mutate(date = mdy(date))
  }else{
    data <- fredmd(
      filepath, 
      date_start = NULL, date_end = NULL, 
      transform = TRUE
    ) %>% rm_outliers.fredmd() 
  }

  # Filter Time Period
  df <- data %>% 
    as_tibble() %>% 
    filter(
      date >= as.Date(input$daterange[1]),
      date <= as.Date(input$daterange[2])
    ) %>% 
    dplyr::select(
      date,
      all_of(c(
        input$index1, 
        input$index2, 
        input$index3
      ))
    ) %>%
    mutate(across(-date, as.numeric)) %>% 
    rename(
      index = date, 
      X1 = !!sym(as.character(input$index1)),
      X2 = !!sym(as.character(input$index2)),
      X3 = !!sym(as.character(input$index3))
    ) %>% 
    drop_na() 

  # Apply Log-Transform
  if (!is.null(input$log_vars)) {
    df <- df %>%
      mutate(across(all_of(input$log_vars), ~ ifelse(. > 0, log(.), NA)))
  }
  df <- df %>%
    mutate(
      X1_mean = segment_mean(X1),
      X2_mean = segment_mean(X2),
      X3_mean = segment_mean(X3)
    )
    df
})

output$ts_plot <- renderPlot({
  df <- df_reactive()
  ggplot(df, aes(x=index)) +
    geom_line(aes(y=X1), color="red") +
    geom_line(aes(y=X2), color="blue") +
    geom_line(aes(y=X3), color="green") +
    geom_line(aes(y=X1_mean), color="red", linetype="dashed") +
    geom_line(aes(y=X2_mean), color="blue", linetype="dashed") +
    geom_line(aes(y=X3_mean), color="green", linetype="dashed") +
    labs(title="Change Point Segmentation", x="", y="") +
    theme_minimal()
})

output$residualPlot <- renderPlot({
  df <- df_reactive()
  ggplot(df, aes(x=index)) +
    geom_hline(yintercept=0) +
    geom_line(aes(y=X1 - X1_mean), color="red") +
    geom_line(aes(y=X2 - X2_mean), color="blue") +
    geom_line(aes(y=X3 - X3_mean), color="green") +
    labs(title="Segmentation Residuals", x="", y="") +
    theme_minimal()
})

output$detrendPlot <- renderPlot({
  df <- df_reactive()

  # Select the columns to detrend
  X <- df %>% dplyr::select(X1, X2, X3)

  # Detrend by subtracting the rotated (lagged) version
  X_detrended <- as.matrix(X) - rotate(as.matrix(X))

  # Bind the detrended data back with the index
  df_detrended <- dplyr::bind_cols(df["index"], X_detrended)

  ggplot(df_detrended, aes(x = index)) +
    geom_hline(yintercept = 0) +
    geom_line(aes(y = X1), color = "red") +
    geom_line(aes(y = X2), color = "blue") +
    geom_line(aes(y = X3), color = "green") + 
    labs(title="Detrended Data", x="", y="") +
    theme_minimal()
})

output$acfPlots <- renderPlot({
  df <- df_reactive()
  par(mfrow=c(1,3))
  acf(df$X1 - df$X1_mean, main="X1")
  acf(df$X2 - df$X2_mean, main="X2")
  acf(df$X3 - df$X3_mean, main="X3")
  par(mfrow=c(1,1))
})

running_ece <- function(x, y, start = 1000) {
  n <- length(x)
  map_dbl(start:n, ~ ece.test(x[1:.x], y[1:.x])$estimate)
}

output$running_ece <- renderPlot({
  df <- df_reactive()
  X1_X2 <- running_ece(df$X1, df$X2)
  X1_X3 <- running_ece(df$X1, df$X3)
  X2_X3 <- running_ece(df$X2, df$X3)

  df <- cbind(index=70:length(df$X1), X1_X2, X1_X3, X2_X3)
  ggplot(data=df) + 
    geom_line(aes(x=index, y=X1_X2, color="X1 vs X2")) + 
    geom_line(aes(x=index, y=X1_X3, color="X1 vs X3")) + 
    geom_line(aes(x=index, y=X2_X3, color="X2 vs X3")) + 
    geom_hline(yintercept=-1) + 
    geom_hline(yintercept= 1) + 
    scale_color_manual(values = c(
      "X1 vs X2" = "red",
      "X1 vs X3" = "blue",
      "X2 vs X3" = "green"
    )) +
    ylab("Correlation") + 
    theme_minimal()
})

output$ece_regression <- renderPlot({
  df <- df_reactive()
  plot.ece(data.frame(X1=df$X1, X2=df$X2))
})

output$cov <- renderPrint({
  df <- df_reactive()
  demean_cov <- cov(cbind(
    df$X1 - df$X1_mean,
    df$X2 - df$X2_mean,
    df$X3 - df$X3_mean
  ))
  colnames(demean_cov) <- rownames(demean_cov) <- c("X1","X2","X3")

  X <- df %>% 
    dplyr::select(X1, X2, X3) %>% 
    as.matrix()

  # Pearson
  pearson_cov <- cov(X)    
  colnames(pearson_cov) <- rownames(pearson_cov) <- c("X1","X2","X3")

  # Detrend
  detrend_cov <- cov((X - rotate(X))[-nrow(X),]) / 2    
  colnames(detrend_cov) <- rownames(detrend_cov) <- c("X1","X2","X3")

  # ECE
  ece_cov <- equiv.cov(as.matrix(X))
  colnames(ece_cov) <- rownames(ece_cov) <- c("X1","X2","X3")

  cat("\nPearson Covariance:\n")
  print(round(pearson_cov, 3))
  cat("\nDetrend Covariance:\n")
  print(round(detrend_cov, 3))
  cat("\nDemean Covariance:\n")
  print(round(demean_cov, 3))
  cat("\nECE Covariance:\n")
  print(round(ece_cov, 3))
})

output$cor <- renderPrint({
  df <- df_reactive()
  demean_cor <- cor(cbind(
    df$X1 - df$X1_mean,
    df$X2 - df$X2_mean,
    df$X3 - df$X3_mean
  ))
  colnames(demean_cor) <- rownames(demean_cor) <- c("X1","X2","X3")

  X <- df %>% 
    dplyr::select(X1, X2, X3) %>%
    as.matrix()

  # Pearson
  pearson_cor <- cor(X)    
  colnames(pearson_cor) <- rownames(pearson_cor) <- c("X1","X2","X3")

  # Detrend
  detrend_cor <- cov2cor(cov((X - rotate(X))[-nrow(X),]) / 2)
  colnames(detrend_cor) <- rownames(detrend_cor) <- c("X1","X2","X3")

  # ECE
  ece_cor <- cov2cor(equiv.cov(as.matrix(X)))
  colnames(ece_cor) <- rownames(ece_cor) <- c("X1","X2","X3")

  cat("\nPearson Correlation:\n")
  print(round(pearson_cor, 3))
  cat("\nDetrend Correlation:\n")
  print(round(detrend_cor, 3))
  cat("\nDemean Correlation:\n")
  print(round(demean_cor, 3))
  cat("\nECE Correlation:\n")
  print(round(ece_cor, 3))
})

output$pvals <- renderPrint({

  df <- df_reactive()
  X <- df %>% 
    dplyr::select(X1, X2, X3) %>% 
    as.matrix()

  # Pearson
  pearson_pval <- cor_pval(X)

  # Detrend
  detrend_pval <- cor_pval(detrend(X))

  # ECE 
  ece_pval <- ece_pval(X)

  # Segmentation
  demean_pval <- cor_pval(cbind(
    df$X1 - df$X1_mean,
    df$X2 - df$X2_mean,
    df$X3 - df$X3_mean
  ))

  # Output Results
  cat("\nPearson P-Values:\n")
  print(round(pearson_pval, 3))
  cat("\nDetrend P-Values:\n")
  print(round(detrend_pval, 3))
  cat("\nDemean P-Values:\n")
  print(round(demean_pval, 3))
  cat("\nECE P-Values:\n")
  print(round(ece_pval, 3))

})

```

::: columns

::: {.column width=50%}
```{R}
choices <- c(
  "RPI", "W875RX1", "DPCERA3M086SBEA",
  "CMRMTSPLx", "RETAILx", "INDPRO", "IPFPNSS",
  "IPFINAL", "IPCONGD", "IPDCONGD", "IPNCONGD",
  "IPBUSEQ", "IPMAT", "IPDMAT", "IPNMAT",
  "IPMANSICS", "IPB51222S", "IPFUELS", "CUMFNS",
  "HWI", "HWIURATIO", "CLF16OV", "CE16OV",
  "UNRATE", "UEMPMEAN", "UEMPLT5", "UEMP5TO14",
  "UEMP15OV", "UEMP15T26", "UEMP27OV", "CLAIMSx",
  "PAYEMS", "USGOOD", "CES1021000001", "USCONS",
  "MANEMP", "DMANEMP", "NDMANEMP", "SRVPRD",
  "USTPU", "USWTRADE", "USTRADE", "USFIRE",
  "USGOVT", "CES0600000007", "AWOTMAN", "AWHMAN",
  "HOUST", "HOUSTNE", "HOUSTMW", "HOUSTS",
  "HOUSTW", "PERMIT", "PERMITNE", "PERMITMW",
  "PERMITS", "PERMITW", "ACOGNO", "AMDMNOx",
  "ANDENOx", "AMDMUOx", "BUSINVx", "ISRATIx",
  "M1SL", "M2SL", "M2REAL", "BOGMBASE",
  "TOTRESNS", "NONBORRES", "BUSLOANS", "REALLN",
  "NONREVSL", "CONSPI", "S&P 500", "S&P div yield",
  "S&P PE ratio", "FEDFUNDS", "CP3Mx", "TB3MS",
  "TB6MS", "GS1", "GS5", "GS10",
  "AAA", "BAA", "COMPAPFFx", "TB3SMFFM",
  "TB6SMFFM", "T1YFFM", "T5YFFM", "T10YFFM",
  "AAAFFM", "BAAFFM", "TWEXAFEGSMTHx", "EXSZUSx",
  "EXJPUSx", "EXUSUKx", "EXCAUSx", "WPSFD49207",
  "WPSFD49502", "WPSID61", "WPSID62", "OILPRICEx",
  "PPICMM", "CPIAUCSL", "CPIAPPSL", "CPITRNSL",
  "CPIMEDSL", "CUSR0000SAC", "CUSR0000SAD", "CUSR0000SAS",
  "CPIULFSL", "CUSR0000SA0L2", "CUSR0000SA0L5", "PCEPI",
  "DDURRG3M086SBEA", "DNDGRG3M086SBEA", "DSERRG3M086SBEA", "CES0600000008",
  "CES2000000008", "CES3000000008", "UMCSENTx", "DTCOLNVHFNM",
  "DTCTHFNM", "INVEST", "VIXCLSx"
)

selectInput(
  "index1", "Index 1:",
  choices = choices,
  selected = "FEDFUNDS"
)

selectInput(
  "index2", "Index 2:",
  choices = choices,
  selected = "AAA"
)

selectInput(
  "index3", "Index 3:",
  choices = choices,
  selected = "S&P 500"
)

```
::: 

::: {.column width=50%}
```{R}
dateRangeInput("daterange", "Choose dates:",
               start = "2000-01-01",
               end   = "2022-12-01",
               min   = "2000-01-01",
               max   = "2024-01-01")

radioButtons(
  "data_format", "Data Format:",
  choices = c("Raw" = "raw", "Transformed" = "transformed"),
  selected = "raw"
)

checkboxGroupInput(
  "log_vars", "Apply log transformation to:",
  choices = c("X1", "X2", "X3"),
  selected = NULL
)

```
::: 

::: 




::: {.panel-tabset}

## Plot
```{R}
#| panel: fill
plotOutput("ts_plot")
```


## Residuals
```{R}
#| panel: fill
plotOutput("residualPlot")
```

## Detrend
```{R}
#| panel: fill
plotOutput("detrendPlot")
```

## ACF
```{R}
#| panel: fill
plotOutput("acfPlots")
```

## Stability
```{R}
#| panel: fill
plotOutput("running_ece")
```

## ECE-Regression
```{R}
#| panel: fill
plotOutput("ece_regression")
```

:::



::: {.panel-tabset}

## Correlation
::: columns

::: {.column width="50%"}

```{R}
verbatimTextOutput("cor")
```
:::

::: {.column width="50%"}
```{R}
verbatimTextOutput("pvals")
```
:::

:::

## Covariance
```{R}
verbatimTextOutput("cov")
```

:::

--- 

# Notes
The FRED data comes with its own recommendations for the transformation. These transformations are designed to produce stationary series. Common techniques are log-detrending. 

The problem with any kind of detrending is bias from sharp change points. 

