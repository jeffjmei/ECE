---
title: Air Quality - Station
output: html_document
author: Jeffrey Mei
date: 2025-08-26
link: https://aqs.epa.gov/aqsweb/airdata/download_files.html
server: shiny
---


```{R}
#| echo: false 
#| context: setup
#| message: false
#| warning: false

# Load Packages
devtools::load_all("~/Documents/Research/Code/ECE")
library(tidyverse)
library(changepoint)
```

We collect air-quality data from the [EPA](https://aqs.epa.gov/aqsweb/airdata/download_files.html). For more information, [look here](https://www.epa.gov/outdoor-air-quality-data/about-air-data-reports). In this analysis, we compare the **ozone levels** of three metropolitan areas at a time.  

We can get daily reports from [this website](https://www.epa.gov/outdoor-air-quality-data/air-quality-index-daily-values-report), which has seems to have complete data, but the user must specify what location to choose. In this case, we've gathered data from Pima County. 

::: columns

::: {.column width=50%}
```{R}
selectInput(
  "pollutant1", "Pollutant 1:",
  choices = c("co", "ozone", "pm10", "pm25", "no2"),
  selected = "ozone"
)

selectInput(
  "pollutant2", "Pollutant 2:",
  choices = c("co", "ozone", "pm10", "pm25", "no2"),
  selected = "pm25"
)

selectInput(
  "pollutant3", "Pollutant 3:",
  choices = c("co", "ozone", "pm10", "pm25", "no2"),
  selected = "pm10"
)

```
:::

::: {.column width=50%}
```{R}
dateRangeInput("daterange", "Choose dates:",
               start = "2017-01-01",
               end   = "2025-09-01",
               min   = "2020-01-01",
               max   = Sys.Date())

selectInput(
  "county", "County:",
  choices = c("pima", "maricopa", "harris", "la", "clark", "butte", "kern", "shasta"),
  selected = "pima"
)
```
:::

:::


```{R}
#| context: server

df_reactive <- reactive({

  data_dir <- "~/Documents/Research/Code/ECE/data/air-quality/"
  files <- list.files(
    path = data_dir,
    pattern = paste0("aqidaily.*", input$county, ".*\\.csv$"),
    full.names = TRUE
  )
  raw_df <- map_dfr(
    files, ~ read_csv(.x, col_types = cols(.default = "c"))
  )

  # Process Data
  df <- raw_df %>% 
    janitor::clean_names() %>% 
    dplyr::select(
      date,
      all_of(c(
        input$pollutant1, 
        input$pollutant2, 
        input$pollutant3
      ))
    ) %>%
    mutate(across(-date, as.numeric)) %>% 
    rename(
      index = date, 
      X1 = !!sym(as.character(input$pollutant1)),
      X2 = !!sym(as.character(input$pollutant2)),
      X3 = !!sym(as.character(input$pollutant3))
    ) %>% 
    drop_na() %>% 
    mutate(
      index = lubridate::mdy(index),
      X1_mean = segment_mean(X1),
      X2_mean = segment_mean(X2),
      X3_mean = segment_mean(X3)
    )
})

#| context: server
output$stockPlot <- renderPlot({
  df <- df_reactive()
  ggplot(df, aes(x=index)) +
    geom_line(aes(y=X1), color="red") +
    geom_line(aes(y=X2), color="blue") +
    geom_line(aes(y=X3), color="green") +
    geom_line(aes(y=X1_mean), color="red", linetype="dashed") +
    geom_line(aes(y=X2_mean), color="blue", linetype="dashed") +
    geom_line(aes(y=X3_mean), color="green", linetype="dashed") +
    labs(title="Change Point Segmentation", x="", y="") +
    theme_minimal()
})

output$residualPlot <- renderPlot({
  df <- df_reactive()
  ggplot(df, aes(x=index)) +
    geom_hline(yintercept=0) +
    geom_line(aes(y=X1 - X1_mean), color="red") +
    geom_line(aes(y=X2 - X2_mean), color="blue") +
    geom_line(aes(y=X3 - X3_mean), color="green") +
    labs(title="Segmentation Residuals", x="", y="") +
    theme_minimal()
})

output$detrendPlot <- renderPlot({
  df <- df_reactive()

  # Select the columns to detrend
  X <- df %>% dplyr::select(X1, X2, X3)

  # Detrend by subtracting the rotated (lagged) version
  X_detrended <- as.matrix(X) - rotate(as.matrix(X))

  # Bind the detrended data back with the index
  df_detrended <- dplyr::bind_cols(df["index"], X_detrended)

  ggplot(df_detrended, aes(x = index)) +
    geom_hline(yintercept = 0) +
    geom_line(aes(y = X1), color = "red") +
    geom_line(aes(y = X2), color = "blue") +
    geom_line(aes(y = X3), color = "green") + 
    labs(title="Detrended Data", x="", y="") +
    theme_minimal()
})

output$acfPlots <- renderPlot({
  df <- df_reactive()
  par(mfrow=c(1,3))
  acf(df$X1 - df$X1_mean, main="X1")
  acf(df$X2 - df$X2_mean, main="X2")
  acf(df$X3 - df$X3_mean, main="X3")
  par(mfrow=c(1,1))
})

running_ece <- function(x, y, start = 1000) {
  n <- length(x)
  map_dbl(start:n, ~ ece.test(x[1:.x], y[1:.x])$estimate)
}

output$running_ece <- renderPlot({
  df <- df_reactive()
  X1_X2 <- running_ece(df$X1, df$X2)
  X1_X3 <- running_ece(df$X1, df$X3)
  X2_X3 <- running_ece(df$X2, df$X3)

  df <- cbind(index=70:length(df$X1), X1_X2, X1_X3, X2_X3)
  ggplot(data=df) + 
    geom_line(aes(x=index, y=X1_X2, color="X1 vs X2")) + 
    geom_line(aes(x=index, y=X1_X3, color="X1 vs X3")) + 
    geom_line(aes(x=index, y=X2_X3, color="X2 vs X3")) + 
    geom_hline(yintercept=-1) + 
    geom_hline(yintercept= 1) + 
    scale_color_manual(values = c(
      "X1 vs X2" = "red",
      "X1 vs X3" = "blue",
      "X2 vs X3" = "green"
    )) +
    ylab("Correlation") + 
    theme_minimal()
})

output$ece_regression <- renderPlot({
  df <- df_reactive()
  plot.ece(data.frame(X1=df$X1, X2=df$X2))
})

#| context: server
output$ece_cov <- renderPrint({
  df <- df_reactive()
  demean_cov <- cov(cbind(
    df$X1 - df$X1_mean,
    df$X2 - df$X2_mean,
    df$X3 - df$X3_mean
  ))
  colnames(demean_cov) <- rownames(demean_cov) <- c("X1","X2","X3")

  X <- df %>% 
    dplyr::select(X1, X2, X3) %>% 
    as.matrix()

  # Pearson
  pearson_cov <- cov(X)    
  colnames(pearson_cov) <- rownames(pearson_cov) <- c("X1","X2","X3")

  # Detrend
  detrend_cov <- cov((X - rotate(X))[-nrow(X),]) / 2    
  colnames(detrend_cov) <- rownames(detrend_cov) <- c("X1","X2","X3")

  # ECE
  ece_cov <- equiv.cov(as.matrix(X))
  colnames(ece_cov) <- rownames(ece_cov) <- c("X1","X2","X3")

  cat("Pearson Covariance:\n")
  print(round(pearson_cov, 3))
  cat("Detrend Covariance:\n")
  print(round(detrend_cov, 3))
  cat("Demean Covariance:\n")
  print(round(demean_cov, 3))
  cat("\nECE Covariance:\n")
  print(round(ece_cov, 3))
})

output$ece_cor <- renderPrint({
  df <- df_reactive()
  demean_cor <- cor(cbind(
    df$X1 - df$X1_mean,
    df$X2 - df$X2_mean,
    df$X3 - df$X3_mean
  ))
  colnames(demean_cor) <- rownames(demean_cor) <- c("X1","X2","X3")

  X <- df %>% 
    dplyr::select(X1, X2, X3) %>%
    as.matrix()

  # Pearson
  pearson_cor <- cor(X)    
  colnames(pearson_cor) <- rownames(pearson_cor) <- c("X1","X2","X3")

  # Detrend
  detrend_cor <- cov2cor(cov((X - rotate(X))[-nrow(X),]) / 2)
  colnames(detrend_cor) <- rownames(detrend_cor) <- c("X1","X2","X3")

  # ECE
  ece_cor <- cov2cor(equiv.cov(as.matrix(X)))
  colnames(ece_cor) <- rownames(ece_cor) <- c("X1","X2","X3")

  cat("\nPearson Correlation:\n")
  print(round(pearson_cor, 3))
  cat("\nDetrend Correlation:\n")
  print(round(detrend_cor, 3))
  cat("Demean Correlation:\n")
  print(round(demean_cor, 3))
  cat("\nECE Correlation:\n")
  print(round(ece_cor, 3))
})
```



::: {.panel-tabset}

## Plot
```{R}
#| panel: fill
plotOutput("stockPlot")
```


## Residuals
```{R}
#| panel: fill
plotOutput("residualPlot")
```

We see a little bit of heteroscedasticity. Whatever variance/covariance we estimate, it will be the average across this time interval.

## Detrend
```{R}
#| panel: fill
plotOutput("detrendPlot")
```

## ACF
```{R}
#| panel: fill
plotOutput("acfPlots")
```

Given this segmentation, it looks like there's still some auto-correlation. It's hard to claim this is due to inadequate fitting since it the fit is already so tight. This intrinsic auto-correlation deflates the estimated correlation. This means our estimated correlation will be deflated from the true value. 

## Stability
```{R}
#| panel: fill
plotOutput("running_ece")
```

## ECE-Regression
```{R}
#| panel: fill
plotOutput("ece_regression")
```

:::



::: {.panel-tabset}

## Correlation
::: columns

::: {.column width="50%"}

```{R}
verbatimTextOutput("ece_cor")
```
:::

::: {.column width="50%"}
```{R}
verbatimTextOutput("ece_cor")
```
:::

:::

## Covariance
```{R}
verbatimTextOutput("ece_cov")
```

:::


---

::: {.callout-note collapse="true"}
## Ozone and PM10 have Inverse Relationships
In Harris County, segmentation does not seem to show this relationship. Generally speaking, segmentation produces more muted negative correlations. 

::: 

# Related Literature

::: {.callout-note collapse="true"}
## Correlation Between Ozone and Particles
Source: [Correlation Between Ozone and Particles](https://www.sciencedirect.com/science/article/pii/S1309104223001927)

This paper studies the relationship between Ozone (O3) and particulate matter (e.g. PM10 and PM2.5) in Tehran. Tehran suffers from dust storms, which create an uptick in particulate matter. 

They essentially show that the interactions between O3 and PM25/PM10 are related to their relative levels. For example, O3 is more correlated with high levels of PM25/PM10, whereas it is less correlated with low levels of PM25/PM10. 

> Surface O3 formation is suppressed under high particulate matter (PM) levels in the atmosphere, in particular PM2.5, likely due to weakened photochemical reactions (lower solar radiation and air temperature), dilution effect, and heterogeneous chemical processes occurring onto the PM2.5 surface (reactive uptake of nitrogen oxides, NOx, and hydrogen oxide radicals, HOx). 
::: 


::: {.callout-note collapse="true"}
## COVID Stringency Index Correlation with Pollution
Source: [COVID Stringency Index Correlation with Pollution](https://pmc.ncbi.nlm.nih.gov/articles/PMC10542101/)

The COVID stringency index roughly corresponds to how strict a lock down is (e.g. school closures, etc.). This study evaluates how the stringency index correlates with air pollution. That is, do stricter lock down policies correspond to less pollution?

The interesting thing here is that the stringency index they use is not stochastic. It is essentially a constant piecewise function. ECE would evaluate 0 correlation. Worse, it would produce a degenerate correlation matrix. 

![Stringency Matrix](https://cdn.ncbi.nlm.nih.gov/pmc/blobs/429a/10542101/d91ad7f57af0/trp-24-5-253_f002.jpg){width=75%}
::: 

::: {.callout-note collapse="true"}
## Correlations Between Pollutants in China
Source: [Correlations Between Pollutants in China](https://www.mdpi.com/2073-4433/10/7/352)

The authors observe different levels of correlation between O3 and PM2.5. They investigate it throughout time and space. 

![Bivariate-Plots](https://pub.mdpi-res.com/atmosphere/atmosphere-10-00352/article_deploy/html/images/atmosphere-10-00352-g002.png?1564734333){width=75%}

![Time-Series](https://pub.mdpi-res.com/atmosphere/atmosphere-10-00352/article_deploy/html/images/atmosphere-10-00352-g003.png?1564734332){width=75%}

I'm not sure if it makes sense to apply our method to this work. The authors report correlation between pollutants to support the argument that some chemical effect is taking place that inhibits the production of Ozone. 

::: 

::: {.callout-note collapse="true"}
Source: [Co-occurrence of extremes in surface ozone, particulate matter, and temperature over eastern North America](https://www.pnas.org/doi/abs/10.1073/pnas.1614453114)

They get the correlation between pollutants after de-trending. It is not a good comparison with our method because de-trending tends to remove any change points. 
![](https://www.pnas.org/cms/10.1073/pnas.1614453114/asset/b0183e17-1a43-495a-aa46-c7df69f4e8d4/assets/graphic/pnas.1614453114fig01.jpeg){width=75%}

::: 


# Thoughts
The way correlation is often used is in a regression context. $X$ is high, so $Y$ is high. 

What scientists care about is whether a high value of $X$ is associated with a high value of $Y$. When they talk about correlation, they are not interested in measuring the noise. They are interested in providing evidence that there is a systematic relationship between the two variables. 

Instead, our method aims to remove the systematic relationship and estimate the correlation in the noise. This may be helpful in determining that there remains unexplained variation. 

::: {.callout-note collapse="true"}
## We expect detrend to be positively biased. 
We should expect PM2.5 and PM10 to be positively correlated. However, because of wildfires that plague Butte county, there are obvious spikes in PM2.5 and PM10 counts. This is similar to scenario 15, where we see that detrend is positively biased in these cases. However, segmentation tends to be _negatively biased_ in scenario 15 simulations. In this example, we see that ECE is much lower than both of the estimates. 

When we look at the "stability" plot, we see this dataset is fairly volatile. Nevertheless, the stability plot in the simulations are fairly healthy. Even when considering the range of correlations ECE explored, it doesn't fall right in the middle of the two. It's unreasonable to expect this to occur because this should only occur on average. 

The story is this: detrending tends to be inflated, and ECE, while often somewhat volatile, is less biased. 

**This is not true for Maricopa.** In this case, ECE estimates a much higher correlation. 
::: 

::: {.callout-note collapse="true"}
## ECE consistently produces smaller correlation between PM2.5 and PM10 
Part of this is that the variance estimates are extremely different. 
:::
